<UserControl x:Class="TournamentManager.Client.Views.BracketsView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             x:Name="Root">
  <Grid Margin="16" Background="{StaticResource SecondaryBrush}">
    <Grid.RowDefinitions>
      <RowDefinition Height="Auto"/>
      <RowDefinition Height="*"/>
    </Grid.RowDefinitions>

    <Border Grid.Row="0" Style="{StaticResource PanelStyle}" Padding="12">
      <TextBlock Text="Турнирные сетки" Style="{StaticResource HeaderTextStyle}"/>
    </Border>

    <Border Grid.Row="1" Style="{StaticResource CardStyle}" Padding="0">
      <TabControl>
        <TabControl.ItemContainerStyle>
          <Style TargetType="TabItem">
            <Setter Property="Header" Value="{Binding CategoryDisplay}"/>
          </Style>
        </TabControl.ItemContainerStyle>
        <TabControl.ContentTemplate>
          <DataTemplate>
            <ScrollViewer VerticalScrollBarVisibility="Auto">
              <Grid Margin="16">
                <Grid.ColumnDefinitions>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="*"/>
                  <ColumnDefinition Width="*"/>
                </Grid.ColumnDefinitions>

                <!-- Первый столбец: стартовые пары (у обеих участников есть имена) -->
                <StackPanel Grid.Column="0">
                  <TextBlock Text="Раунд 1" Style="{StaticResource SubHeaderTextStyle}" Margin="0,0,0,8"/>
                  <ItemsControl ItemsSource="{Binding Matches}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Margin="0,0,0,8" Padding="8" Background="{StaticResource WhiteBrush}" CornerRadius="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                          <Grid>
                            <Grid.ColumnDefinitions>
                              <ColumnDefinition Width="*"/>
                              <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <StackPanel>
                              <TextBlock Text="{Binding FirstParticipantName}" Style="{StaticResource BodyTextStyle}"/>
                              <TextBlock Text="{Binding SecondParticipantName}" Style="{StaticResource BodyTextStyle}"/>
                            </StackPanel>
                            <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Center"
                                        Visibility="{Binding SecondParticipantName, Converter={StaticResource NullToCollapsedConverter}}">
                              <TextBox Width="100" Margin="0,0,8,0" Text="{Binding FirstParticipantScore, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}" IsEnabled="{Binding CanEdit}"/>
                              <TextBlock Text=":" Margin="0,0,8,0"/>
                              <TextBox Width="100" Margin="0,0,8,0" Text="{Binding SecondParticipantScore, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" Style="{StaticResource TextBoxStyle}" IsEnabled="{Binding CanEdit}"/>
                              <Button Content="Начать" Style="{StaticResource SecondaryButtonStyle}"
                                      Command="{Binding DataContext.StartMatchCommand, ElementName=Root}"
                                      CommandParameter="{Binding}"/>
                              <Button Content="Завершить" Margin="8,0,0,0" Style="{StaticResource PrimaryButtonStyle}"
                                      Command="{Binding DataContext.FinishMatchCommand, ElementName=Root}"
                                      CommandParameter="{Binding}"/>
                              <Button Content="Редактировать" Margin="8,0,0,0" Style="{StaticResource SecondaryButtonStyle}"
                                      Visibility="{Binding DataContext.IsOrganizer, ElementName=Root, Converter={StaticResource BooleanToVisibilityConverter}}"
                                      Command="{Binding DataContext.EditMatchCommand, ElementName=Root}"
                                      CommandParameter="{Binding}"/>
                            </StackPanel>
                          </Grid>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                    <ItemsControl.ItemsPanel>
                      <ItemsPanelTemplate>
                        <StackPanel/>
                      </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                  </ItemsControl>
                </StackPanel>

                <!-- Второй столбец: сформированные пары следующего раунда (возможно один участник ожидает соперника) -->
                <StackPanel Grid.Column="1">
                  <TextBlock Text="Раунд 2" Style="{StaticResource SubHeaderTextStyle}" Margin="0,0,0,8"/>
                  <ItemsControl ItemsSource="{Binding Matches}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Margin="0,0,0,8" Padding="8" Background="{StaticResource WhiteBrush}" CornerRadius="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1"
                                Visibility="{Binding SecondParticipantName, Converter={StaticResource NullToVisibleConverter}}">
                          <StackPanel>
                            <TextBlock Text="{Binding FirstParticipantName}" Style="{StaticResource BodyTextStyle}"/>
                            <TextBlock Text="{Binding SecondParticipantName, TargetNullValue=Ожидает соперника}" Style="{StaticResource HintTextStyle}"/>
                          </StackPanel>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>
                </StackPanel>

                <!-- Третий столбец: финал + блок для 3-го места -->
                <StackPanel Grid.Column="2">
                  <TextBlock Text="Финал" Style="{StaticResource SubHeaderTextStyle}" Margin="0,0,0,8"/>
                  <!-- Простейшее отображение: последний матч списка как финал -->
                  <ContentPresenter Content="{Binding Matches[0]}" Visibility="Collapsed"/>
                  <ItemsControl ItemsSource="{Binding Matches}">
                    <ItemsControl.ItemTemplate>
                      <DataTemplate>
                        <Border Margin="0,0,0,8" Padding="8" Background="{StaticResource WhiteBrush}" CornerRadius="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                          <StackPanel>
                            <TextBlock Text="{Binding FirstParticipantName}" Style="{StaticResource BodyTextStyle}"/>
                            <TextBlock Text="{Binding SecondParticipantName}" Style="{StaticResource BodyTextStyle}"/>
                          </StackPanel>
                        </Border>
                      </DataTemplate>
                    </ItemsControl.ItemTemplate>
                  </ItemsControl>

                  <TextBlock Text="Схватка за 3-е место" Style="{StaticResource SubHeaderTextStyle}" Margin="16,16,0,8"/>
                  <Border Padding="8" Background="{StaticResource WhiteBrush}" CornerRadius="4" BorderBrush="{StaticResource BorderBrush}" BorderThickness="1">
                    <TextBlock Text="Будет сформирована после полуфиналов" Style="{StaticResource HintTextStyle}"/>
                  </Border>
                </StackPanel>

              </Grid>
            </ScrollViewer>
          </DataTemplate>
        </TabControl.ContentTemplate>
        <TabControl.ItemsSource>
          <Binding Path="DataContext.Brackets" RelativeSource="{RelativeSource AncestorType=UserControl}"/>
        </TabControl.ItemsSource>
      </TabControl>
    </Border>
  </Grid>
</UserControl>
